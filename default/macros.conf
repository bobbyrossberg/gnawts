[nodedown]
args = 
definition = `nodedown(node=*, secs=601)`
errormsg = 
iseval = 0
validation = 

[nodedown(1)]
args = node
definition = `nodedown(node=$node$, secs=601)`
errormsg = 
iseval = 0
validation = 

[nodedown(2)]
args = node,secs
definition = [search $node$ sourcetype=moabs etype=nodedown | eval start=_time-$secs$ | eval end=_time+1 | eval query = " _time>" . start . " _time<" . end . " " . node | fields + query | format maxresults=1000]
errormsg = 
iseval = 0
validation = 

[job(1)]
args = jobid
definition = `job(jobid=$jobid$, latest=now)`
errormsg = 
iseval = 0
validation = 

[job(2)]
args = jobid,latest
definition = (sourcetype=slurm Job_id=$jobid$) OR (sourcetype=slurmj JobId=$jobid$) OR [search sourcetype=moabs job=$jobid$ latest=$latest$ | head 1 | eval end=if(start==end, now(), _time) | eval start=start-1 | eval end=end+1 | makemv delim="," nodes | mvexpand nodes | dedup nodes | eval query = " _time>=" . start . " _time<= " . end .  " " . nodes | fields + query | format maxresults=1000] | search NOT syslog-ng
errormsg = 
iseval = 0
validation = 

[jmtti(1)]
args = days
definition = index=summary nodeStateChange=*-ERR | lookup nodes nid OUTPUT node | lookup jobe node OUTPUT job htime | search job>1 | dedup job htime | timechart span=1d count AS jobERRCountToday | join _time [ search index=summary systemUptimeHoursToday] | fields + systemUptimeHoursToday jobERRCountToday | streamstats sum(systemUptimeHoursToday) AS systemUptimeHoursInWindow window=$days$ | streamstats sum(jobERRCountToday) AS jobERRCountInWindow window=$days$ | eval JMTTI=systemUptimeHoursInWindow/jobERRCountInWindow | timechart max(JMTTI) AS JMTTI
errormsg = Number of days must be positive.
iseval = 0
validation = days>0

[smtti(1)]
args = days
definition = index=summary systemUptimeHoursToday=* | sort info_max_time | streamstats sum(systemUptimeHoursToday) AS systemUptimeHoursInWindow window=$days$ | streamstats sum(systemERRCountToday) AS systemERRCountInWindow window=$days$ | eval systemERRCountInWindow=if(systemERRCountInWindow>0,systemERRCountInWindow,1) | eval SMTTI=round(systemUptimeHoursInWindow/systemERRCountInWindow,2) | eval _time=info_max_time | timechart max(SMTTI) AS SMTTI | sort _time |  nointerpolate
errormsg = Number of days must be positive.
iseval = 0
validation = days>0

[el(1)]
args = days
definition = index=summary systemUptimeHoursToday=* | sort info_max_time | streamstats sum(systemUptimeHoursToday) AS systemUptimeHoursInWindow window=$days$ | eval EL=100*systemUptimeHoursInWindow/(24*$days$) | timechart max(EL) AS EL
errormsg = Number of days must be positive.
iseval = 0
validation = days>0

[systemUptimeYesterday]
args = 
definition = `systemUptimeYesterday(now())`
errormsg = 
iseval = 0

[systemUptimeYesterday(1)]
args = Today
# gentimes may help avoid the below subsearch craziness
definition = [search index=summary systemStateChange=* | head 1 | eval query="index=summary systemStateChange=* latest=" . relative_time($Today$, "-1d@d") | fields + query ] | head 1 | eval Time=relative_time($Today$, "-1d@d") | eval Fake=1 | append [search [ search index=summary systemStateChange=* | head 1 | eval query="index=summary systemStateChange=* latest=" . relative_time($Today$, "-0d@d") | fields + query ] | head 1 | eval Time=relative_time($Today$, "-0d@d") | eval Fake=1] | append [search [search index=summary systemStateChange=* | head 1 | eval query="index=summary systemStateChange=* earliest=" . relative_time($Today$, "-1d@d") . " latest=" . relative_time($Today$, "-0d@d") | fields + query] | eval Time=_time] | sort Time | delta Time AS durationSeconds | eval systemUptimeHours=if(systemStateChange="USR-ERR" AND ((crossing="increasing" AND NOT Fake=1) OR (crossing="decreasing" AND Fake=1)),round(durationSeconds/3600,2),0) | eval systemERR=if(systemStateChange="USR-ERR" AND crossing="increasing" AND NOT Fake=1,1,0) | stats sum(systemUptimeHours) AS systemUptimeHoursToday, sum(systemERR) as systemERRCountToday | eval info_min_time=round(relative_time($Today$, "-1d@d"),0) | eval info_max_time=round(relative_time($Today$, "-0d@d"),0) | eval _time=info_min_time
errormsg = 
iseval = 0
validation = 

[nodedownsince]
args = 
definition = `nodedownsince(14)`
errormsg = 
iseval = 0
validation = 

[nodedownsince(1)]
args = days
definition = [| savedsearch StateChange  | statechange "{'USR-ERR_Threshold':7, 'nodeField':'nids'}" | tail 1 | lookup hostlist short AS StateName_ERR OUTPUT long | makemv delim="," long | mvexpand long | eval query="index=summary earliest=".now()-$days$*86400." nodeStateChange=*-ERR nid=".long | fields + query | format] | eval HoursSinceDown=(now() - _time)/3600.0 | eval LatestTimeDown=strftime(_time, "%m/%d/%y:%H:%M:%S") | stats min(HoursSinceDown) as HoursSinceDown max(LatestTimeDown) as LatestTimeDown count as CountInWindow BY nid | table nid CountInWindow LatestTimeDown HoursSinceDown
errormsg = 
iseval = 0
validation = 

[nodedownsincecjs]
# special test one for Charlie since I don't get up-to-date events
args = 
definition = [search tag=state latest=03/14/2011:00:00:00 | statechange "{'USR-ERR_Threshold':7, 'nodeField':'nids'}" | tail 1 | lookup hostlist short AS StateName_ERR OUTPUT long | makemv delim="," long | mvexpand long | eval query="index=summary latest=03/14/2011:00:00:00 nodeStateChange=*-ERR nid=".long | fields + query | format] | eval HoursSinceDown=(now() - _time)/3600.0 | eval LatestTimeDown=strftime(_time, "%m/%d/%y:%H:%M:%S") | stats min(HoursSinceDown) as HoursSinceDown max(LatestTimeDown) as LatestTimeDown count as CountInWindow BY nid | table nid CountInWindow LatestTimeDown HoursSinceDown
errormsg = 
iseval = 0
validation = 
